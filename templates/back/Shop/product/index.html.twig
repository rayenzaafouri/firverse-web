{% extends 'base.html.twig' %}

{% block title %}Admin - Products{% endblock %}

{% block stylesheets %}
{{ parent() }}
<link rel="stylesheet" href="{{ asset('/styles/admin.css') }}">
<style>
.transparent-container img {
    mix-blend-mode: multiply;
}
.action-buttons {
    display: flex;
    gap: 0.3rem;
    justify-content: center;
}
table th:nth-child(4),
table td:nth-child(4) {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
/* Fix dropdown visibility */
.product-filter-dropdown .dropdown-menu {
    z-index: 2000 !important;
    display: block;
    visibility: hidden;
    opacity: 0;
    transition: opacity 0.2s ease;
    position: absolute;
}
.product-filter-dropdown.show .dropdown-menu {
    visibility: visible;
    opacity: 1;
}
</style>
{% endblock %}

{% block body %}
<div class="admin-dashboard-layout">
    <div id="sidenavAccordion">
        {% include 'back/admin/sidenav.html.twig' %}
    </div>

    <div class="container py-5">
        <h1 class="mb-4">Manage Products</h1>

        <div class="mb-3 d-flex align-items-center">
            <a href="{{ path('app_product_new') }}" class="btn btn-success me-2">+ Create New Product</a>

            <div class="ms-auto d-flex align-items-center gap-2">
                <!-- Search -->
                <div class="position-relative" style="width: 300px;">
                    <div class="input-group">
                        <input id="searchInput" type="text" class="form-control" placeholder="Search products...">
                        <button id="searchButton" class="btn btn-primary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="searchResults" class="list-group position-absolute w-100 mt-1"
                         style="max-height: 160px; overflow-y: auto; display: none;"></div>
                </div>

                <!-- Filter -->
                <div class="dropdown product-filter-dropdown">
                    <button id="filterDropdownToggle" class="btn btn-outline-info dropdown-toggle" type="button">
                        <i class="material-symbols-outlined me-1" style="font-size:1.2em;">filter_alt</i>
                        Filter
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" id="filterDropdownMenu">
                        <li><a class="dropdown-item category-filter" href="#" data-category="">All Categories</a></li>
                        {% for category in categories %}
                            <li>
                                <a class="dropdown-item category-filter" href="#" data-category="{{ category.name }}">
                                    {{ category.name }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <table class="table table-striped text-center align-middle">
            <thead class="thead-dark">
                <tr>
                    <th>Actions</th>
                    <th>ID</th>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Brand</th>
                    <th>Price (TND)</th>
                    <th>Stock</th>
                    <th>Category</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                    <tr class="product-row"
                        data-name="{{ product.name|lower }}"
                        data-category="{{ product.category ? product.category.name : '' }}">
                        <td>
                            <div class="action-buttons">
                                <a href="{{ path('app_product_show', {'id': product.id}) }}" class="btn btn-sm btn-primary">View</a>
                                <a href="{{ path('app_product_edit', {'id': product.id}) }}" class="btn btn-sm btn-warning">Edit</a>
                                {{ include('back/shop/product/_delete_form.html.twig') }}
                            </div>
                        </td>
                        <td>{{ product.id }}</td>
                        <td class="transparent-container">
                            <img src="{{ product.imageUrl }}" class="card-img-top" style="height: 100px; object-fit: contain;">
                        </td>
                        <td>{{ product.name }}</td>
                        <td>{{ product.brand }}</td>
                        <td>{{ product.price|number_format(2) }}</td>
                        <td>{{ product.stock }}</td>
                        <td>{{ product.category ? product.category.name : 'â€”' }}</td>
                    </tr>
                {% else %}
                    <tr><td colspan="8" class="text-muted">No products found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const searchButton = document.getElementById('searchButton');
    const productRows = document.querySelectorAll('.product-row');
    const categoryFilters = document.querySelectorAll('.category-filter');
    const filterToggle = document.getElementById('filterDropdownToggle');
    const filterDropdown = document.querySelector('.product-filter-dropdown');
    let currentCategory = '';

    function filterProducts() {
        const query = searchInput.value.toLowerCase();
        let visible = 0;
        productRows.forEach(row => {
            const matchName = query === '' || row.dataset.name.includes(query);
            const matchCat = currentCategory === '' || row.dataset.category === currentCategory;
            if (matchName && matchCat) {
                row.style.display = '';
                visible++;
            } else {
                row.style.display = 'none';
            }
        });
    }

    function updateSearchResults(query) {
        searchResults.innerHTML = '';
        if (!query.length) {
            searchResults.style.display = 'none';
            filterProducts();
            return;
        }

        let count = 0;
        productRows.forEach(row => {
            if (row.dataset.name.includes(query) && count < 20) {
                const item = document.createElement('div');
                item.className = 'list-group-item';
                item.textContent = row.querySelector('td:nth-child(4)').textContent;
                item.onclick = () => {
                    searchInput.value = item.textContent;
                    searchResults.style.display = 'none';
                    currentCategory = '';
                    filterProducts();
                };
                searchResults.appendChild(item);
                count++;
            }
        });

        searchResults.style.display = count ? 'block' : 'none';
    }

    searchInput.addEventListener('input', () => {
        updateSearchResults(searchInput.value.toLowerCase());
    });

    categoryFilters.forEach(el => {
        el.addEventListener('click', e => {
            e.preventDefault();
            currentCategory = el.dataset.category;
            filterProducts();
            filterDropdown.classList.remove('show');
        });
    });

    filterToggle.addEventListener('click', e => {
        e.stopPropagation();
        filterDropdown.classList.toggle('show');
    });

    document.addEventListener('click', e => {
        if (!filterDropdown.contains(e.target)) {
            filterDropdown.classList.remove('show');
        }
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
