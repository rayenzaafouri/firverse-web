{% extends 'back/admin/dashboard-skeleton.html.twig' %}

{% block title %}Admin – Users{% endblock %}

{% block header %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{{ path('admin_dashboard') }}">Dashboard</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ path('app_user_index') }}">Users</a>
        </li>
    </ol>
</nav>
{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
  .sortable { cursor: pointer; }
  .sortable:after { content: '▾'; font-size: .6em; opacity: .5; margin-left: .2em; transition: transform .2s; }
  .sortable.sorted-asc:after  { transform: rotate(180deg); opacity:1; }
  .sortable.sorted-desc:after { opacity:1; }
  
  .pagination {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    margin: 2rem 0;
    list-style: none;
    padding: 0;
  }

  .pagination li {
    /* no border-radius → perfectly square */
  }

  .pagination li a,
  .pagination li span {
    display: inline-block;
    padding: 0.6rem 1rem;
    background: #ecf0f1;
    color: #2c3e50;
    text-decoration: none;
    border: 1px solid #bdc3c7;
    box-shadow: inset 0 0 0 rgba(0,0,0,0);
    transition: background 0.2s, color 0.2s;
  }

  .pagination li a:hover {
    background: #bdc3c7;
    color: #fff;
  }

  .pagination li.active span,
  .pagination li.active a {
    background: #2c3e50;
    color: #ecf0f1;
    border-color: #2c3e50;
    font-weight: bold;
  }

  .pagination li.disabled span {
    background: #f5f5f5;
    color: #95a5a6;
    border-color: #ddd;
    pointer-events: none;
  }
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
  <h2>List of Users</h2>
  <input type="text" id="searchInput" value="{{ search }}" placeholder="Search..." style="padding: .5rem; width:200px;">
  <div>
    <a href="{{ path('app_user_new') }}" class="btn btn-success">+ New User</a>
    <a href="{{ path('app_user_export_pdf') }}" class="btn btn-secondary">Export to PDF</a>
    <a href="{{ path('app_user_stats') }}" class="btn btn-info">View Role Stats</a>
  </div>
</div>

<div id="listContainer">
  {% include 'user/_list.html.twig' with {
    pagination: pagination,
    search: search,
    sortField: sortField,
    sortDir: sortDir
  } %}
</div>

<script>
(() => {
  const container = document.getElementById('listContainer');
  const searchInput = document.getElementById('searchInput');
  let sortField = '{{ sortField }}', sortDir = '{{ sortDir }}';

  function load(page = 1) {
    const q = encodeURIComponent(searchInput.value);
    fetch(`{{ path('app_user_list_html') }}?search=${q}&sortField=${sortField}&sortDir=${sortDir}&page=${page}`)
      .then(r => r.text())
      .then(html => {
        container.innerHTML = html;
        bindClicks();
      });
  }

  function bindClicks() {
    container.querySelectorAll('th.sortable a').forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        const params = new URL(a.href).searchParams;
        sortField = params.get('sortField');
        sortDir = params.get('sortDir');
        load(1);
      });
    });
    container.querySelectorAll('.pagination a').forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        const page = new URL(a.href).searchParams.get('page');
        load(page);
      });
    });
  }

  searchInput.addEventListener('input', () => load(1));
  bindClicks();
})();
</script>
{% endblock %}
