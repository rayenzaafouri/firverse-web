{% extends 'base.html.twig' %}

{% block title %}Admin - Products{% endblock %}
{% block stylesheets %}
<style>
.transparent-container {
  background: transparent; /* or any desired background */
  img {
  mix-blend-mode: multiply;
    }
}
</style>
{% endblock %}
{% block body %}
{% include 'navbar.html.twig' %}

<div class="container py-5">
    <h1 class="mb-4">Manage Products</h1>

    <div class="mb-3 d-flex align-items-center">
        <a href="{{ path('app_product_new') }}" class="btn btn-success me-2">+ Create New Product</a>
        
        <div class="ms-auto d-flex align-items-center gap-2">
            <div class="position-relative" style="width: 300px;">
                <div class="input-group">
                    <input id="searchInput" type="text" class="form-control" placeholder="Search products...">
                    <button id="searchButton" class="btn btn-primary" type="button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div id="searchResults" class="list-group position-absolute w-100 mt-1" style="max-height: 160px; overflow-y: auto; display: none; z-index: 1000;"></div>
            </div>
          
            <div class="btn-group">
                <button class="btn btn-outline-info dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown">
                    <i class="material-symbols-outlined me-1" style="font-size:1.2em;">filter_alt</i>
                    <span>Filter</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item category-filter" href="#" data-category="">All Categories</a></li>
                    {% for category in categories %}
                    <li>
                        <a class="dropdown-item category-filter" href="#" data-category="{{ category.name }}">
                            {{ category.name }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <table class="table table-striped text-center align-middle">
    <thead class="thead-dark">
        <tr>
            <th>Actions</th> 
            <th>ID</th>
            <th>Image</th>
            <th>Name</th>
            <th>Brand</th>
            <th>Price (TND)</th>
            <th>Stock</th>
            <th>Category</th>
        </tr>
    </thead>
    <tbody>
    {% for product in products %}
        <tr class="product-row" data-name="{{ product.name|lower }}" data-category="{{ product.category ? product.category.name : '' }}">
            <td> 
                <a href="{{ path('app_product_show', {'id': product.id}) }}" class="btn btn-sm btn-primary">View</a>
                <a href="{{ path('app_product_edit', {'id': product.id}) }}" class="btn btn-sm btn-warning">Edit</a>
                {{ include('back/shop/product/_delete_form.html.twig') }}
            </td>
            <td>{{ product.id }}</td>
            <td class="transparent-container"><img src="{{ product.imageUrl }}" class="card-img-top" style="height: 100px; object-fit: contain;"></td>
            <td>{{ product.name }}</td>
            <td>{{ product.brand }}</td>
            <td>{{ product.price|number_format(2) }}</td>
            <td>{{ product.stock }}</td>
            <td>
                {% if product.category %}
                    {{ product.category.name }}
                {% else %}
                    <span class="text-muted">No Category</span>
                {% endif %}
            </td>
        </tr>
    {% else %}
        <tr>
            <td colspan="8" class="text-muted">No products found.</td>
        </tr>
    {% endfor %}
    </tbody>
</table>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const searchButton = document.getElementById('searchButton');
    const productRows = document.querySelectorAll('.product-row');
    const categoryFilters = document.querySelectorAll('.category-filter');
    let currentCategory = '';

    function updateSearchResults(query) {
        searchResults.innerHTML = '';
        
        if (query.length === 0) {
            searchResults.style.display = 'none';
            filterProducts();
            return;
        }

        let matches = 0;
        productRows.forEach(row => {
            const name = row.dataset.name;
            if (name.includes(query)) {
                if (matches < 20) { // Limit to 20 items max for performance
                    const item = document.createElement('div');
                    item.className = 'list-group-item';
                    item.style.cursor = 'pointer';
                    item.textContent = row.querySelector('td:nth-child(4)').textContent;
                    item.onclick = function() {
                        searchInput.value = row.querySelector('td:nth-child(4)').textContent;
                        searchResults.style.display = 'none';
                        filterProducts();
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        row.classList.add('highlight');
                        setTimeout(() => row.classList.remove('highlight'), 2000);
                    };
                    searchResults.appendChild(item);
                }
                matches++;
            }
        });

        if (matches > 0) {
            searchResults.style.display = 'block';
            searchResults.style.maxHeight = '160px'; // Show ~4 items at a time
        } else {
            searchResults.style.display = 'none';
        }
    }

    // Search on input
    searchInput.addEventListener('input', function() {
        updateSearchResults(this.value.toLowerCase());
    });

    // Search on button click
    searchButton.addEventListener('click', function() {
        updateSearchResults(searchInput.value.toLowerCase());
        filterProducts();
    });

    // Category filter functionality
    categoryFilters.forEach(filter => {
        filter.addEventListener('click', function(e) {
            e.preventDefault();
            currentCategory = this.dataset.category;
            filterProducts();
        });
    });

    // Combined filter function
    function filterProducts() {
        const searchQuery = searchInput.value.toLowerCase();
        
        productRows.forEach(row => {
            const matchesSearch = searchQuery === '' || row.dataset.name.includes(searchQuery);
            const matchesCategory = currentCategory === '' || row.dataset.category === currentCategory;
            
            if (matchesSearch && matchesCategory) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && 
            !searchResults.contains(e.target) && 
            !searchButton.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });

    // Press Enter to search
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            updateSearchResults(this.value.toLowerCase());
            filterProducts();
        }
    });
});
</script>

{% endblock %}