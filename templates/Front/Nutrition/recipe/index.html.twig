{% extends 'base.html.twig' %}

{% block title %}Recipe List{% endblock %}

{% block body %}
{% include 'navbar.html.twig' %}
    <div class="container mt-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">Recipe List</h1>
                <a href="{{ path('app_recipe_new') }}" class="btn btn-light">
                    <i class="fas fa-plus"></i> Create new
                </a>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                            </div>
                            <input type="text" id="recipeSearch" class="form-control" placeholder="Search recipes...">
                        </div>
                    </div>
                </div>

                <!-- Filter Controls -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Filters</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="ingredientFilter">Number of Ingredients</label>
                                            <select id="ingredientFilter" class="form-control">
                                                <option value="all">All</option>
                                                <option value="1-3">1-3 ingredients</option>
                                                <option value="4-6">4-6 ingredients</option>
                                                <option value="7-9">7-9 ingredients</option>
                                                <option value="10+">10+ ingredients</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="timesUsedFilter">Times Used</label>
                                            <select id="timesUsedFilter" class="form-control">
                                                <option value="all">All</option>
                                                <option value="0">Never used</option>
                                                <option value="1-5">1-5 times</option>
                                                <option value="6-10">6-10 times</option>
                                                <option value="11+">11+ times</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="favoriteFilter">Favorite Status</label>
                                            <select id="favoriteFilter" class="form-control">
                                                <option value="all">All</option>
                                                <option value="favorite">Favorites only</option>
                                                <option value="not-favorite">Not favorites</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12 text-right">
                                        <button id="resetFilters" class="btn btn-secondary btn-sm">
                                            <i class="fas fa-undo"></i> Reset Filters
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row" id="recipeGrid">
                    {% for recipe in recipes %}
                        <div class="col-md-4 mb-4 recipe-card" 
                             data-ingredients="{{ recipe.foods|length }}"
                             data-times-used="{{ recipe.timesUsed }}"
                             data-favorite="{{ recipe.isFavoris ? 'true' : 'false' }}">
                            <div class="card h-100 shadow-sm">
                                <div class="card-header bg-light">
                                    <h5 class="card-title mb-0">{{ recipe.name }}</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <strong>Ingredients:</strong>
                                        <div class="mt-2">
                                            {% for food in recipe.foods %}
                                                <span class="badge badge-info mr-1 mb-1">{{ food.name }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Times Used:</strong> {{ recipe.timesUsed }}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Favorite:</strong>
                                        {% if recipe.isFavoris %}
                                            <i class="fas fa-star text-warning"></i>
                                        {% else %}
                                            <i class="far fa-star text-muted"></i>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="card-footer bg-light">
                                    <div class="btn-group w-100">
                                        <a href="{{ path('app_recipe_show', {'id': recipe.id}) }}" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                        <a href="{{ path('app_recipe_edit', {'id': recipe.id}) }}" class="btn btn-sm btn-warning">
                                            <i class="fas fa-edit"></i> Edit
                                        </a>
                                        <form method="post" action="{{ path('app_recipe_delete', {'id': recipe.id}) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this recipe?');">
                                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ recipe.id) }}">
                                            <button class="btn btn-sm btn-danger" title="Delete">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                No recipes found. Create your first recipe!
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('recipeSearch');
            const recipeCards = document.querySelectorAll('.recipe-card');
            const ingredientFilter = document.getElementById('ingredientFilter');
            const timesUsedFilter = document.getElementById('timesUsedFilter');
            const favoriteFilter = document.getElementById('favoriteFilter');
            const resetFiltersBtn = document.getElementById('resetFilters');
            
            // Function to apply all filters
            function applyFilters() {
                const searchText = searchInput.value.toLowerCase();
                const ingredientValue = ingredientFilter.value;
                const timesUsedValue = timesUsedFilter.value;
                const favoriteValue = favoriteFilter.value;
                
                let visibleCount = 0;
                
                recipeCards.forEach(function(card) {
                    const cardText = card.textContent.toLowerCase();
                    const ingredients = parseInt(card.dataset.ingredients);
                    const timesUsed = parseInt(card.dataset.timesUsed);
                    const isFavorite = card.dataset.favorite === 'true';
                    
                    // Check if card matches search text
                    const matchesSearch = cardText.indexOf(searchText) > -1;
                    
                    // Check if card matches ingredient filter
                    let matchesIngredients = true;
                    if (ingredientValue !== 'all') {
                        if (ingredientValue === '1-3' && (ingredients < 1 || ingredients > 3)) {
                            matchesIngredients = false;
                        } else if (ingredientValue === '4-6' && (ingredients < 4 || ingredients > 6)) {
                            matchesIngredients = false;
                        } else if (ingredientValue === '7-9' && (ingredients < 7 || ingredients > 9)) {
                            matchesIngredients = false;
                        } else if (ingredientValue === '10+' && ingredients < 10) {
                            matchesIngredients = false;
                        }
                    }
                    
                    // Check if card matches times used filter
                    let matchesTimesUsed = true;
                    if (timesUsedValue !== 'all') {
                        if (timesUsedValue === '0' && timesUsed !== 0) {
                            matchesTimesUsed = false;
                        } else if (timesUsedValue === '1-5' && (timesUsed < 1 || timesUsed > 5)) {
                            matchesTimesUsed = false;
                        } else if (timesUsedValue === '6-10' && (timesUsed < 6 || timesUsed > 10)) {
                            matchesTimesUsed = false;
                        } else if (timesUsedValue === '11+' && timesUsed < 11) {
                            matchesTimesUsed = false;
                        }
                    }
                    
                    // Check if card matches favorite filter
                    let matchesFavorite = true;
                    if (favoriteValue !== 'all') {
                        if (favoriteValue === 'favorite' && !isFavorite) {
                            matchesFavorite = false;
                        } else if (favoriteValue === 'not-favorite' && isFavorite) {
                            matchesFavorite = false;
                        }
                    }
                    
                    // Show/hide card based on all filters
                    if (matchesSearch && matchesIngredients && matchesTimesUsed && matchesFavorite) {
                        card.style.display = '';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                });
                
                // Show "no results" message if needed
                const noResultsAlert = document.querySelector('.alert-info');
                if (visibleCount === 0) {
                    if (!noResultsAlert) {
                        const alert = document.createElement('div');
                        alert.className = 'col-12';
                        alert.innerHTML = '<div class="alert alert-info text-center">No recipes match your filters.</div>';
                        document.getElementById('recipeGrid').appendChild(alert);
                    }
                } else if (noResultsAlert) {
                    noResultsAlert.parentNode.removeChild(noResultsAlert);
                }
            }
            
            // Event listeners for filters
            searchInput.addEventListener('keyup', applyFilters);
            ingredientFilter.addEventListener('change', applyFilters);
            timesUsedFilter.addEventListener('change', applyFilters);
            favoriteFilter.addEventListener('change', applyFilters);
            
            // Reset filters
            resetFiltersBtn.addEventListener('click', function() {
                searchInput.value = '';
                ingredientFilter.value = 'all';
                timesUsedFilter.value = 'all';
                favoriteFilter.value = 'all';
                applyFilters();
            });
        });
    </script>
{% endblock %} 