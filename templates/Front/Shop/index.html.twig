{% extends 'base.html.twig' %}

{% block title %}Shop{% endblock %}

{% block stylesheets %}
<style>
    .card-body {
        padding: 0.75rem; 
    }
    .card-title {
        font-size: 1.25rem;
    }
    .card-text {
        font-size: 0.85rem;
    }
    .btn-success {
        background-color: #28a745;
        border-color: #28a745;
    }
    #searchResults {
        position: absolute;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        width: calc(100% - 40px); /* Account for search button width */
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    #searchResults .list-group-item {
        border: none;
        border-bottom: 1px solid #dee2e6;
        padding: 0.5rem 1rem;
    }
    #searchResults .list-group-item:last-child {
        border-bottom: none;
    }
    #searchResults .list-group-item:hover {
        background-color: #f8f9fa;
    }
    .product-img {
        height: 150px;
        object-fit: contain;
        padding: 0.5rem;
    }
    .discount-badge {
        top: 0.5rem;
        left: 0.5rem;
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const cards = document.querySelectorAll('.product-card');
    const categorySelect = document.getElementById('categorySelect');

    function filterProducts() {
        const searchText = searchInput.value.toLowerCase();
        const selectedCategory = categorySelect.value;

        cards.forEach(card => {
            const name = card.dataset.name.toLowerCase();
            const category = card.dataset.category;
            const matchesName = name.includes(searchText);
            const matchesCategory = selectedCategory === '' || category === selectedCategory;

            if (matchesName && matchesCategory) {
                card.classList.remove('d-none');
            } else {
                card.classList.add('d-none');
            }
        });
    }

    searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        searchResults.innerHTML = '';

        filterProducts();

        if (query.length > 0) {
            let matches = 0;
            cards.forEach(card => {
                if (!card.classList.contains('d-none')) {
                    const name = card.dataset.name.toLowerCase();
                    if (name.includes(query)) {
                        const div = document.createElement('a');
                        div.textContent = card.dataset.name;
                        div.classList.add('list-group-item', 'list-group-item-action');
                        div.href = 'javascript:void(0)';
                        div.addEventListener('click', () => {
                            searchInput.value = card.dataset.name;
                            filterProducts();
                            searchResults.style.display = 'none';
                        });
                        searchResults.appendChild(div);
                        matches++;
                    }
                }
            });

            searchResults.style.display = matches > 0 ? 'block' : 'none';
        } else {
            searchResults.style.display = 'none';
        }
    });

    document.getElementById('searchButton').addEventListener('click', filterProducts);
    categorySelect.addEventListener('change', filterProducts);

    // Close search results when clicking outside
    document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });
});
</script>
{% endblock %}

{% block body %}
{% include 'navbar.html.twig' %}

<div class="container py-5">
    {# Search Bar #}
    <div class="row justify-content-center mb-4">
        <div class="col-md-4 position-relative">
            <div class="input-group">
                <input id="searchInput" type="text" class="form-control" placeholder="Search products..." aria-label="Search products">
                <button id="searchButton" class="btn btn-primary" type="button">search
                </button>
            </div>
            <div id="searchResults" class="list-group position-absolute mt-1"></div>
        </div>
    </div>

    {# Action Buttons Row #}
    <div class="d-flex justify-content-between mb-4">
        <a href="{{ path('cart_index') }}" class="btn btn-primary">
            View Cart
        </a>
        
        <div class="col-md-3">
            <select id="categorySelect" class="form-select">
                <option value="">All Categories</option>
                {% for category in categories %}
                    <option value="{{ category.name }}">{{ category.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    {# Products Grid #}
    <div class="row g-4">
        {% for product in products %}
            {% set discount = 0 %}
            {% set now = "now"|date('U') %}

            {% for discountEntity in product.productDiscounts %}
                {% if discount == 0 and discountEntity.validFrom|date('U') <= now and discountEntity.validUntil|date('U') >= now %}
                    {% set discount = discountEntity.discountPercentage %}
                {% endif %}
            {% endfor %}

            <div class="col-12 col-sm-6 col-md-4 col-lg-3 product-card" 
                 data-name="{{ product.name }}" data-category="{{ product.category.name }}">
                <div class="card h-100 shadow-sm position-relative">
                    {% if discount > 0 %}
                        <span class="badge bg-danger position-absolute discount-badge">
                            <div>{{ discount }}% Discount </div>
                        </span>
                    {% endif %}

                    <img src="{{ product.imageUrl }}" class="card-img-top product-img" alt="{{ product.name }}">

                    <div class="card-body d-flex flex-column p-3">
                        <h5 class="card-title mb-2">{{ product.name }}</h5>
                        <p class="card-text text-muted small mb-2">
                            {{ product.description|length > 40 ? product.description|slice(0, 40) ~ '...' : product.description }}
                        </p>

                        <div class="mt-auto">
                            {% if discount > 0 %}
                                <p class="mb-1">
                                    <small class="text-muted">
                                        <del>{{ product.price|number_format(2) }} TND</del>
                                    </small>
                                </p>
                                <p class="text-danger fw-bold mb-3">
                                    {{ (product.price * (1 - discount/100))|number_format(2) }} TND
                                </p>
                            {% else %}
                                <p class="text-dark fw-bold mb-3">{{ product.price|number_format(2) }} TND</p>
                            {% endif %}

                            <div class="d-flex gap-5">
                                <form method="POST" action="{{ path('cart_add', {'id': product.id}) }}" class="d-inline">
                                    <input type="hidden" name="_token" value="{{ csrf_token('add' ~ product.id) }}">
                                    <button type="submit" class="btn btn-success btn-sm flex-grow-1">
                                        <i class="bi bi-cart-plus me-1"></i> Add to cart
                                    </button>
                                </form>

                                <a href="{{ path('productdetail', {'id': product.id}) }}" 
                                   class="btn btn-primary btn-sm flex-grow-1">
                                    <i class="bi bi-eye me-1"></i> View
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="col-12 text-center text-muted py-5">
                <i class="bi bi-exclamation-circle fs-1"></i>
                <h4 class="mt-3">No products found</h4>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}