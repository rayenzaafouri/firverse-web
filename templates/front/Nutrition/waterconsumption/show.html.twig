{% extends 'base.html.twig' %}

{% block title %}Water Consumption for {{ waterconsumption.consumptionDate|date('Y-m-d') }}{% endblock %}

{% block body %}
{% include 'navbar.html.twig' %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 mx-auto">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h3 class="mb-0">Water Consumption <small class="text-white-50" style="font-size:0.7em">(2L goal)</small></h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Date:</strong> {{ waterconsumption.consumptionDate|date('Y-m-d') }}
                    </div>
                    <div class="mb-3">
                        <strong>Amount Consumed:</strong>
                        <span id="water-amount-display">{{ waterconsumption.amountConsumed ?? 0 }}</span> liters
                    </div>
                    <div class="mb-3">
                        <div class="progress" style="height: 25px;">
                            {% set goal = 2 %}
                            {% set consumed = waterconsumption.amountConsumed ?? 0 %}
                            {% set percent = (consumed / goal * 100) > 100 ? 100 : (consumed / goal * 100) %}
                            <div class="progress-bar bg-info" role="progressbar" style="width: {{ percent }}%;" aria-valuenow="{{ consumed }}" aria-valuemin="0" aria-valuemax="{{ goal }}">
                                {{ percent|round(0, 'floor') }}%
                            </div>
                        </div>
                        <small class="text-muted">Goal: 2 liters</small>
                    </div>
                    <form method="POST" action="{{ path('app_waterconsumption_update', {'date': waterconsumption.consumptionDate|date('Y-m-d')}) }}" id="water-form">
                        <div class="input-group mb-3" style="max-width: 400px;">
                            <input type="number" name="amount_consumed" id="water-amount-input" class="form-control" step="0.01" min="0" value="{{ waterconsumption.amountConsumed ?? 0 }}" required>
                            <span class="input-group-text">liters</span>
                            <button class="btn btn-primary" type="submit">Update</button>
                        </div>
                        <div class="btn-group mb-2" role="group">
                            <button type="button" class="btn btn-outline-info" onclick="incrementWater(0.25)">+250ml</button>
                            <button type="button" class="btn btn-outline-info" onclick="incrementWater(0.5)">+500ml</button>
                            <button type="button" class="btn btn-outline-info" onclick="incrementWater(0.75)">+750ml</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
</div>



<script>
function toggleSmsService() {
    const isChecked = document.getElementById('smsToggle').checked;
    const status = document.getElementById('sms-status');
    if (isChecked) {
        status.textContent = 'Active';
        status.className = 'text-success';
    } else {
        status.textContent = 'Inactive';
        status.className = 'text-secondary';
    }
}
</script>

<!-- Line Chart for Last 10 Days -->
<div class="container mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0 text-info">Water Consumption (Last 10 Days)</h5>
                </div>
                <div class="card-body">
                    <canvas id="waterChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Chart data from Twig
    const chartLabels = [
        {% for entry in last10days %}
            '{{ entry.consumptionDate|date('m-d') }}'{% if not loop.last %}, {% endif %}
        {% endfor %}
    ];
    const chartData = [
        {% for entry in last10days %}
            {{ entry.amountConsumed ?? 0 }}{% if not loop.last %}, {% endif %}
        {% endfor %}
    ];

    const ctx = document.getElementById('waterChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Liters Consumed',
                data: chartData,
                borderColor: '#17a2b8',
                backgroundColor: 'rgba(23,162,184,0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 4,
                pointBackgroundColor: '#17a2b8',
                pointBorderColor: '#fff',
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    max: 2.5,
                    title: { display: true, text: 'Liters' },
                    grid: { display: false }
                },
                x: {
                    grid: { display: false }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: { enabled: true }
            }
        }
    });

    function incrementWater(amount) {
        const input = document.getElementById('water-amount-input');
        let current = parseFloat(input.value) || 0;
        current += amount;
        input.value = current.toFixed(2);
        document.getElementById('water-amount-display').innerText = input.value;
    }
</script>
{% endblock %}
