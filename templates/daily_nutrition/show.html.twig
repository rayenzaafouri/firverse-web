{% extends 'base.html.twig' %}

{% block title %}Nutrition for {{ nutrition.date|date('Y-m-d') }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .search-container {
            position: relative;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .search-result-item:hover {
            background-color: #f8f9fa;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .item-type-badge {
            font-size: 0.8em;
            margin-left: 5px;
        }
        .nutrition-info {
            font-size: 0.8em;
            color: #666;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">Nutrition for {{ nutrition.date|date('Y-m-d') }}</h1>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12 text-center">
                <a href="{{ path('app_daily_nutrition_index') }}" class="btn btn-secondary">
                    Back to List
                </a>
            </div>
        </div>

        {% for meal_type in meal_types %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header {% if meal_type == 'breakfast' %}bg-primary{% elseif meal_type == 'lunch' %}bg-success{% elseif meal_type == 'dinner' %}bg-info{% else %}bg-warning{% endif %} text-white">
                            <h3 class="mb-0">{{ meal_type|capitalize }}</h3>
                        </div>
                        <div class="card-body">
                            <!-- Search Form -->
                            <div class="mb-3">
                                <form action="{{ path('app_daily_nutrition_add_item', {
                                    'date': nutrition.date|date('Y-m-d'),
                                    'mealType': meal_type
                                }) }}" method="post" class="search-container">
                                    <input type="hidden" name="selected_item" id="selected_item_{{ meal_type }}">
                                    <div class="input-group">
                                        <input type="text" 
                                               class="form-control search-input" 
                                               placeholder="Search for foods or recipes..."
                                               data-meal-type="{{ meal_type }}"
                                               autocomplete="off">
                                        <button type="submit" class="btn btn-primary">Add Item</button>
                                    </div>
                                    <div class="search-results" id="search_results_{{ meal_type }}"></div>
                                </form>
                            </div>

                            <!-- Items List -->
                            <ul class="list-group">
                                {% set meal_food_ids = mealFoods[meal_type]|default([]) %}
                                {% for food in nutrition.foods %}
                                    {% if food.id in meal_food_ids %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <h5 class="mb-1">
                                                    {{ food.name }}
                                                    <span class="badge bg-primary">Food</span>
                                                </h5>
                                                <div class="nutrition-info">
                                                    <small class="text-muted">
                                                        Calories: {{ food.calories|default(0) }} |
                                                        Protein: {{ food.protein|default(0) }}g |
                                                        Carbs: {{ food.carbohydrate|default(0) }}g |
                                                        Fat: {{ food.fats|default(0) }}g
                                                    </small>
                                                </div>
                                            </div>
                                            <form action="{{ path('app_daily_nutrition_remove_food', {
                                                'date': nutrition.date|date('Y-m-d'),
                                                'foodId': food.id,
                                                'mealType': meal_type
                                            }) }}" method="post" class="d-inline">
                                                <input type="hidden" name="_method" value="POST">
                                                <button type="submit" class="btn btn-sm btn-danger">
                                                    Remove
                                                </button>
                                            </form>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                {% set meal_recipe_ids = mealRecipes[meal_type]|default([]) %}
                                {% for recipe in nutrition.recipes %}
                                    {% if recipe.id in meal_recipe_ids %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <h5 class="mb-1">
                                                    {{ recipe.name }}
                                                    <span class="badge bg-success">Recipe</span>
                                                </h5>
                                                <div class="nutrition-info">
                                                    <small class="text-muted">
                                                        {% set totalCalories = 0 %}
                                                        {% set totalProtein = 0 %}
                                                        {% set totalCarbs = 0 %}
                                                        {% set totalFats = 0 %}
                                                        {% for food in recipe.foods %}
                                                            {% set totalCalories = totalCalories + (food.calories|default(0)) %}
                                                            {% set totalProtein = totalProtein + (food.protein|default(0)) %}
                                                            {% set totalCarbs = totalCarbs + (food.carbohydrate|default(0)) %}
                                                            {% set totalFats = totalFats + (food.fats|default(0)) %}
                                                        {% endfor %}
                                                        Calories: {{ totalCalories|round }} |
                                                        Protein: {{ totalProtein|round }}g |
                                                        Carbs: {{ totalCarbs|round }}g |
                                                        Fat: {{ totalFats|round }}g
                                                    </small>
                                                </div>
                                            </div>
                                            <form action="{{ path('app_daily_nutrition_remove_recipe', {
                                                'date': nutrition.date|date('Y-m-d'),
                                                'recipeId': recipe.id,
                                                'mealType': meal_type
                                            }) }}" method="post" class="d-inline">
                                                <input type="hidden" name="_method" value="POST">
                                                <button type="submit" class="btn btn-sm btn-danger">
                                                    Remove
                                                </button>
                                            </form>
                                        </li>
                                    {% endif %}
                                                Remove
                                            </button>
                                        </form>
                                    </li>
                                {% endfor %}
                                {% if (meal_food_ids is empty) and (meal_recipe_ids is empty) %}
                                    <li class="list-group-item">No items added</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}

        <!-- Nutrition Summary -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3>Daily Nutrition Summary</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="nutrition-summary-item text-center p-2 rounded bg-light">
                                    <h4 class="mb-0 text-primary">
                                        {% set totalCalories = 0 %}
                                        {% for food in nutrition.foods %}
                                            {% set totalCalories = totalCalories + (food.calories|default(0)) %}
                                        {% endfor %}
                                        {% for recipe in nutrition.recipes %}
                                            {% for food in recipe.foods %}
                                                {% set totalCalories = totalCalories + (food.calories|default(0)) %}
                                            {% endfor %}
                                        {% endfor %}
                                        {{ totalCalories|round }}
                                    </h4>
                                    <small class="text-muted">Calories</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="nutrition-summary-item text-center p-2 rounded bg-light">
                                    <h4 class="mb-0 text-success">
                                        {% set totalProtein = 0 %}
                                        {% for food in nutrition.foods %}
                                            {% set totalProtein = totalProtein + (food.protein|default(0)) %}
                                        {% endfor %}
                                        {% for recipe in nutrition.recipes %}
                                            {% for food in recipe.foods %}
                                                {% set totalProtein = totalProtein + (food.protein|default(0)) %}
                                            {% endfor %}
                                        {% endfor %}
                                        {{ totalProtein|round }}g
                                    </h4>
                                    <small class="text-muted">Protein</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="nutrition-summary-item text-center p-2 rounded bg-light">
                                    <h4 class="mb-0 text-info">
                                        {% set totalCarbs = 0 %}
                                        {% for food in nutrition.foods %}
                                            {% set totalCarbs = totalCarbs + (food.carbohydrate|default(0)) %}
                                        {% endfor %}
                                        {% for recipe in nutrition.recipes %}
                                            {% for food in recipe.foods %}
                                                {% set totalCarbs = totalCarbs + (food.carbohydrate|default(0)) %}
                                            {% endfor %}
                                        {% endfor %}
                                        {{ totalCarbs|round }}g
                                    </h4>
                                    <small class="text-muted">Carbs</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="nutrition-summary-item text-center p-2 rounded bg-light">
                                    <h4 class="mb-0 text-warning">
                                        {% set totalFats = 0 %}
                                        {% for food in nutrition.foods %}
                                            {% set totalFats = totalFats + (food.fats|default(0)) %}
                                        {% endfor %}
                                        {% for recipe in nutrition.recipes %}
                                            {% for food in recipe.foods %}
                                                {% set totalFats = totalFats + (food.fats|default(0)) %}
                                            {% endfor %}
                                        {% endfor %}
                                        {{ totalFats|round }}g
                                    </h4>
                                    <small class="text-muted">Fat</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInputs = document.querySelectorAll('.search-input');
            
            searchInputs.forEach(input => {
                const mealType = input.dataset.mealType;
                const resultsContainer = document.getElementById(`search_results_${mealType}`);
                const selectedItemInput = document.getElementById(`selected_item_${mealType}`);
                let searchTimeout;

                input.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    const query = this.value.trim();
                    
                    if (query.length < 2) {
                        resultsContainer.style.display = 'none';
                        return;
                    }

                    searchTimeout = setTimeout(() => {
                        fetch(`/nutrition/user/dailynutrition/search-items?q=${encodeURIComponent(query)}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(data => {
                                resultsContainer.innerHTML = '';
                                if (data.length === 0) {
                                    resultsContainer.style.display = 'none';
                                    return;
                                }

                                data.forEach(item => {
                                    const div = document.createElement('div');
                                    div.className = 'search-result-item';
                                    div.innerHTML = `
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>${item.name}</strong>
                                                <span class="badge ${item.type === 'Food' ? 'bg-primary' : 'bg-success'} item-type-badge">
                                                    ${item.type}
                                                </span>
                                            </div>
                                            <small class="text-muted">
                                                ${item.calories} cal | ${item.protein}g protein | ${item.carbohydrate}g carbs | ${item.fats}g fat
                                            </small>
                                        </div>
                                    `;
                                    div.addEventListener('click', () => {
                                        selectedItemInput.value = item.id;
                                        input.value = item.name;
                                        resultsContainer.style.display = 'none';
                                    });
                                    resultsContainer.appendChild(div);
                                });
                                resultsContainer.style.display = 'block';
                            })
                            .catch(error => {
                                console.error('Error fetching search results:', error);
                                resultsContainer.style.display = 'none';
                            });
                    }, 300);
                });

                // Hide results when clicking outside
                document.addEventListener('click', function(e) {
                    if (!input.contains(e.target) && !resultsContainer.contains(e.target)) {
                        resultsContainer.style.display = 'none';
                    }
                });
            });
        });
    </script>
{% endblock %} 